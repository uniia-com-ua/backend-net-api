name: Admin Main API - Docker CI/CD with Fleet

on:
  release:
    types: [published]

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: uniia-admin-api
  SERVICE_PATH: UNIIAadminAPI
  FLEET_PATH: UNIIAadminAPI/fleet

jobs:
  check-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write
    
    # –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —á–∏ —Ü–µ —Ä–µ–ª—ñ–∑ –¥–ª—è admin-api
    if: startsWith(github.event.release.tag_name, 'admin-api-')

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          ref: main

      - name: Extract version from release tag
        id: version
        run: |
          # –í–∏–¥–∞–ª—è—î–º–æ –ø—Ä–µ—Ñ—ñ–∫—Å admin-api- –∑ —Ç–µ–≥—É —Ä–µ–ª—ñ–∑—É
          TAG_NAME="${{ github.event.release.tag_name }}"
          VERSION=${TAG_NAME#admin-api-}
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "Release tag: $TAG_NAME"
          echo "Extracted version: $VERSION"

      - name: Setup .NET
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: '8.0.x'

      - name: Restore dependencies for Admin API
        run: dotnet restore ${{ env.SERVICE_PATH }}/${{ env.SERVICE_PATH }}.csproj

      - name: Build Admin API
        run: dotnet build ${{ env.SERVICE_PATH }}/${{ env.SERVICE_PATH }}.csproj --no-restore

      - name: Test Admin API
        run: dotnet test ${{ env.SERVICE_PATH }}/${{ env.SERVICE_PATH }}.csproj --no-build --verbosity normal

      - name: Log in to the Container registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./${{ env.SERVICE_PATH }}/Dockerfile
          push: true
          tags: |
            ${{ env.REGISTRY }}/uniia-com-ua/${{ env.IMAGE_NAME }}:${{ steps.version.outputs.VERSION }}
            ${{ env.REGISTRY }}/uniia-com-ua/${{ env.IMAGE_NAME }}:latest
          labels: |
            org.opencontainers.image.title=Admin Main API
            org.opencontainers.image.description=UNIIA Admin Main API
            org.opencontainers.image.version=${{ steps.version.outputs.VERSION }}
            org.opencontainers.image.source=${{ github.event.repository.html_url }}
            org.opencontainers.image.revision=${{ github.sha }}

      - name: Update Fleet configuration
        run: |
          echo "üöÄ –û–Ω–æ–≤–ª—é—î–º–æ Fleet –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—é –¥–ª—è Admin Main API..."
          echo "üì¶ –†–µ–ª—ñ–∑: ${{ github.event.release.name }}"
          echo "üè∑Ô∏è  –¢–µ–≥: ${{ github.event.release.tag_name }}"
          echo "üìù –í–µ—Ä—Å—ñ—è: ${{ steps.version.outputs.VERSION }}"
          
          # –ü–µ—Ä–µ–∫–æ–Ω—É—î–º–æ—Å—è —â–æ –º–∏ –Ω–∞ –ø—Ä–∞–≤–∏–ª—å–Ω—ñ–π –≥—ñ–ª—Ü—ñ
          git status
          git branch -a
          
          # –û–Ω–æ–≤–ª—é—î–º–æ —Ç–µ–≥ –æ–±—Ä–∞–∑—É –≤ kustomization.yaml
          sed -i "s/newTag: .*/newTag: ${{ steps.version.outputs.VERSION }}/" ${{ env.FLEET_PATH }}/kustomization.yaml
          
          # –û–Ω–æ–≤–ª—é—î–º–æ –≤–µ—Ä—Å—ñ—é –≤ ConfigMap
          sed -i "s/APP_VERSION: .*/APP_VERSION: \"${{ steps.version.outputs.VERSION }}\"/" ${{ env.FLEET_PATH }}/configmap.yaml
          
          # –ü–æ–∫–∞–∑—É—î–º–æ –∑–º—ñ–Ω–∏
          echo "–ó–º—ñ–Ω–∏ –≤ Fleet –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—ó:"
          echo "=== kustomization.yaml ==="
          git diff ${{ env.FLEET_PATH }}/kustomization.yaml
          echo "=== configmap.yaml ==="
          git diff ${{ env.FLEET_PATH }}/configmap.yaml

      - name: Commit and push Fleet changes
        run: |
          # –ù–∞–ª–∞—à—Ç–æ–≤—É—î–º–æ git
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          # –ü–µ—Ä–µ–∫–æ–Ω—É—î–º–æ—Å—è —â–æ –º–∏ –Ω–∞ main –≥—ñ–ª—Ü—ñ
          echo "Current branch status:"
          git status
          
          # –î–æ–¥–∞—î–º–æ –∑–º—ñ–Ω–∏
          git add ${{ env.FLEET_PATH }}/kustomization.yaml ${{ env.FLEET_PATH }}/configmap.yaml
          
          # –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —á–∏ —î –∑–º—ñ–Ω–∏ –¥–ª—è –∫–æ–º—ñ—Ç—É
          if git diff --staged --quiet; then
            echo "–ù–µ–º–∞—î –∑–º—ñ–Ω –¥–ª—è –∫–æ–º—ñ—Ç—É"
            exit 0
          else
            echo "–ö–æ–º—ñ—Ç–∏–º–æ –∑–º—ñ–Ω–∏..."
            git commit -m "üöÄ [Admin Main API] –†–µ–ª—ñ–∑ ${{ github.event.release.tag_name }}

            –û–Ω–æ–≤–ª–µ–Ω–æ Fleet –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—é –¥–æ –≤–µ—Ä—Å—ñ—ó ${{ steps.version.outputs.VERSION }}
            
            üì¶ –û–±—Ä–∞–∑: ${{ env.REGISTRY }}/uniia-com-ua/${{ env.IMAGE_NAME }}:${{ steps.version.outputs.VERSION }}
            üîß ConfigMap: –í–µ—Ä—Å—ñ—è APP_VERSION = ${{ steps.version.outputs.VERSION }}
            üè∑Ô∏è  –†–µ–ª—ñ–∑: ${{ github.event.release.name }}
            üîó –ü–æ—Å–∏–ª–∞–Ω–Ω—è: ${{ github.event.release.html_url }}
            
            –ö–æ–Ω—Ç—Ä–æ–ª–µ—Ä –º–æ–∂–µ –æ—Ç—Ä–∏–º–∞—Ç–∏ –≤–µ—Ä—Å—ñ—é —á–µ—Ä–µ–∑ endpoint /ver –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—á–∏ env –∑–º—ñ–Ω–Ω—É APP_VERSION"
            
            echo "–í—ñ–¥–ø—Ä–∞–≤–ª—è—î–º–æ –∑–º—ñ–Ω–∏..."
            git push origin main
            echo "‚úÖ Fleet –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—é –æ–Ω–æ–≤–ª–µ–Ω–æ —Ç–∞ –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä—ñ–π"
          fi

      - name: Update release with deployment info
        uses: actions/github-script@v7
        with:
          script: |
            const releaseBody = context.payload.release.body || '';
            const deploymentInfo = `

            ## üöÄ Deployment Info
            - **Docker Image**: \`${{ env.REGISTRY }}/uniia-com-ua/${{ env.IMAGE_NAME }}:${{ steps.version.outputs.VERSION }}\`
            - **App Version (ENV)**: \`${{ steps.version.outputs.VERSION }}\`
            - **Version Endpoint**: \`/ver\` (reads from APP_VERSION env)
            - **Fleet Configuration**: Updated automatically
            - **Deployment Status**: ‚úÖ Ready for Fleet sync

            _Auto-deployed via GitHub Actions_`;
            
            await github.rest.repos.updateRelease({
              owner: context.repo.owner,
              repo: context.repo.repo,
              release_id: context.payload.release.id,
              body: releaseBody + deploymentInfo
            });

      - name: Summary
        run: |
          echo "üéâ Admin Main API —É—Å–ø—ñ—à–Ω–æ –∑—ñ–±—Ä–∞–Ω–æ —Ç–∞ —Ä–æ–∑–≥–æ—Ä–Ω—É—Ç–æ!"
          echo "üì¶ –û–±—Ä–∞–∑: ${{ env.REGISTRY }}/uniia-com-ua/${{ env.IMAGE_NAME }}:${{ steps.version.outputs.VERSION }}"
          echo "üîß APP_VERSION env: ${{ steps.version.outputs.VERSION }}"
          echo "üè∑Ô∏è  –†–µ–ª—ñ–∑: ${{ github.event.release.tag_name }}"
          echo "üîó –ü–æ—Å–∏–ª–∞–Ω–Ω—è –Ω–∞ —Ä–µ–ª—ñ–∑: ${{ github.event.release.html_url }}"
          echo "üìç –í–µ—Ä—Å—ñ—è –¥–æ—Å—Ç—É–ø–Ω–∞ —á–µ—Ä–µ–∑ endpoint /ver"
          echo "üöÄ Fleet –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ —Ä–æ–∑–≥–æ—Ä–Ω–µ –Ω–æ–≤—É –≤–µ—Ä—Å—ñ—é –≤ –∫–ª–∞—Å—Ç–µ—Ä—ñ"